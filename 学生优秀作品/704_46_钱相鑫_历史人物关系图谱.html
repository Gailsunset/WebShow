<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>历史人物关系图谱 | D3版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        body {
            background-color: #f5f5f5;
            overflow: hidden;
        }
        /* 检索页样式 */
        .search-page {
            max-width: 600px;
            width: 90%;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            display: block;
        }
        .search-page h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 22px;
        }
        .search-page p {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .search-input {
            width: 100%;
            height: 45px;
            padding: 0 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 20px;
            outline: none;
            transition: border 0.3s;
        }
        .search-input:focus {
            border-color: #2c68c1;
        }
        .search-btn {
            width: 100%;
            height: 45px;
            background-color: #2c68c1;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .search-btn:hover {
            background-color: #1f5099;
        }
        /* 图谱页样式 */
        .graph-page {
            display: none;
            width: 100%;
            height: 100vh;
            padding: 10px;
            position: relative;
        }
        .back-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 8px 16px;
            background-color: #2c68c1;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            z-index: 1000;
        }
        .back-btn:hover {
            background-color: #1f5099;
        }
        #graph-container {
            width: 100%;
            height: calc(100vh - 60px);
            border: 1px solid #eee;
            border-radius: 4px;
            background: white;
            position: relative;
            overflow: hidden;
        }
        /* D3图谱样式 */
        .node {
            cursor: pointer;
            stroke: #fff;
            stroke-width: 2px;
            transition: r 0.2s;
        }
        .node-label {
            font-size: 12px;
            text-anchor: middle;
            pointer-events: none;
            fill: #333;
            font-weight: bold;
        }
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }
        .link-label {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            fill: #666;
            font-size: 10px;
        }
        /* 搜索结果样式 */
        .search-results {
            margin-top: 20px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        .result-item {
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .result-item:hover {
            background-color: #f0f8ff;
        }
        .result-item h3 {
            color: #2c68c1;
            margin-bottom: 5px;
            font-size: 16px;
        }
        .result-item p {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 0;
        }
        .no-results {
            text-align: center;
            color: #999;
            font-style: italic;
            margin-top: 20px;
        }
        /* 工具提示样式 */
        .tooltip {
            position: absolute;
            padding: 8px 12px;
            background: rgba(0,0,0,0.85);
            color: white;
            border-radius: 4px;
            font-size: 14px;
            z-index: 2000;
            max-width: 200px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        /* 移动端适配 */
        @media (max-width: 768px) {
            .search-page {
                width: 95%;
                margin: 20px auto;
                padding: 20px;
            }
            .search-page h1 {
                font-size: 20px;
            }
            .search-input, .search-btn {
                height: 40px;
                font-size: 14px;
            }
            #graph-container {
                height: calc(100vh - 50px);
            }
            .back-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            .node {
                r: 18 !important;
            }
            .node-label {
                font-size: 11px;
            }
            .link-label {
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <!-- 检索页面 -->
    <div class="search-page" id="searchPage">
        <h1>历史人物关系图谱</h1>
        <p>探索历史名人之间的关联与故事</p>
        <input type="text" class="search-input" id="searchInput" placeholder="请输入要查询的历史人物姓名..." />
        <button class="search-btn" onclick="searchPerson()">搜索人物关系</button>
        <div class="search-results" id="searchResults"></div>
    </div>

    <!-- 图谱展示页面 -->
    <div class="graph-page" id="graphPage">
        <button class="back-btn" onclick="goBack()">← 返回搜索</button>
        <div id="graph-container"></div>
    </div>

    <!-- 引入D3.js库 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // 历史人物关系数据（示例数据）
        const historicalData = {
            "孔子": {
                description: "春秋时期著名思想家、教育家，儒家学派创始人",
                relationships: [
                    { name: "孟子", relation: "后世继承者", type: "师承" },
                    { name: "老子", relation: "同时代思想家", type: "同代" },
                    { name: "颜回", relation: "得意门生", type: "师徒" },
                    { name: "子路", relation: "重要弟子", type: "师徒" }
                ]
            },
            "孟子": {
                description: "战国时期思想家，儒家代表人物，被称为'亚圣'",
                relationships: [
                    { name: "孔子", relation: "思想先师", type: "师承" },
                    { name: "荀子", relation: "儒家后学", type: "同派" },
                    { name: "梁惠王", relation: "政治对话者", type: "君臣" }
                ]
            },
            "老子": {
                description: "春秋时期哲学家，道家学派创始人",
                relationships: [
                    { name: "孔子", relation: "思想交流者", type: "同代" },
                    { name: "庄子", relation: "道家继承者", type: "师承" },
                    { name: "关尹", relation: "早期传播者", type: "弟子" }
                ]
            },
            "秦始皇": {
                description: "秦朝开国皇帝，中国第一个皇帝",
                relationships: [
                    { name: "李斯", relation: "丞相", type: "君臣" },
                    { name: "蒙恬", relation: "大将", type: "君臣" },
                    { name: "吕不韦", relation: "仲父/丞相", type: "君臣" }
                ]
            },
            "汉武帝": {
                description: "西汉第七位皇帝，开创汉武盛世",
                relationships: [
                    { name: "司马迁", relation: "史官", type: "君臣" },
                    { name: "卫青", relation: "大将军", type: "君臣" },
                    { name: "霍去病", relation: "名将", type: "君臣" },
                    { name: "董仲舒", relation: "儒学大家", type: "君臣" }
                ]
            },
            "李白": {
                description: "唐代著名诗人，被誉为'诗仙'",
                relationships: [
                    { name: "杜甫", relation: "诗友", type: "同代文人" },
                    { name: "王维", relation: "同时代诗人", type: "同代文人" },
                    { name: "贺知章", relation: "伯乐", type: "师友" }
                ]
            },
            "杜甫": {
                description: "唐代现实主义诗人，被誉为'诗圣'",
                relationships: [
                    { name: "李白", relation: "诗友", type: "同代文人" },
                    { name: "白居易", relation: "后世诗人", type: "后世" },
                    { name: "高适", relation: "诗友", type: "同代文人" }
                ]
            }
        };

        let svg, simulation, currentNode = null;

        // 搜索功能（优化匹配逻辑）
        function searchPerson() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const resultsContainer = document.getElementById('searchResults');
            
            if (!searchTerm) {
                resultsContainer.innerHTML = '<div class="no-results">请输入要搜索的人物姓名</div>';
                return;
            }

            // 模糊匹配（不区分大小写）
            const matchedPersons = Object.keys(historicalData).filter(name => 
                name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                searchTerm.toLowerCase().includes(name.toLowerCase())
            );

            if (matchedPersons.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">未找到相关历史人物，请尝试：孔子、李白、秦始皇等</div>';
                return;
            }

            // 显示搜索结果
            const resultsHTML = matchedPersons.map(person => `
                <div class="result-item" onclick="showGraph('${person}')">
                    <h3>${person}</h3>
                    <p>${historicalData[person].description}</p>
                </div>
            `).join('');
            
            resultsContainer.innerHTML = resultsHTML;
        }

        // 回车搜索（防重复触发）
        document.getElementById('searchInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.repeat) {
                searchPerson();
            }
        });

        // 显示关系图谱（优化初始化）
        function showGraph(personName) {
            currentNode = personName;
            document.getElementById('searchPage').style.display = 'none';
            document.getElementById('graphPage').style.display = 'block';
            
            // 延迟初始化，确保容器尺寸正确
            setTimeout(() => createGraph(personName), 100);
        }

        // 返回搜索页面（重置状态）
        function goBack() {
            document.getElementById('graphPage').style.display = 'none';
            document.getElementById('searchPage').style.display = 'block';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchInput').value = '';
            currentNode = null;
            
            // 清除现有的SVG和模拟
            if (simulation) simulation.stop();
            d3.select("#graph-container").selectAll("*").remove();
        }

        // 创建关系图谱（核心优化）
        function createGraph(centerPerson) {
            const container = d3.select("#graph-container");
            container.selectAll("*").remove();

            // 获取中心人物的关系数据
            const centerData = historicalData[centerPerson];
            const nodes = [];
            const links = [];

            // 添加中心节点
            nodes.push({
                id: centerPerson,
                name: centerPerson,
                description: centerData.description,
                isCenter: true,
                group: 1
            });

            // 添加相关人物和关系
            centerData.relationships.forEach(rel => {
                const relatedPerson = rel.name;
                
                // 添加相关人物节点
                nodes.push({
                    id: relatedPerson,
                    name: relatedPerson,
                    description: historicalData[relatedPerson] ? historicalData[relatedPerson].description : '历史人物',
                    isCenter: false,
                    group: 2
                });

                // 添加关系连线
                links.push({
                    source: centerPerson,
                    target: relatedPerson,
                    relation: rel.relation,
                    type: rel.type,
                    value: 1
                });
            });

            // 设置画布尺寸（适配容器）
            const width = container.node().clientWidth;
            const height = container.node().clientHeight;

            // 创建SVG
            svg = container.append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            // 创建力导向模拟（优化参数）
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(window.innerWidth < 768 ? 80 : 100))
                .force("charge", d3.forceManyBody().strength(-400))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(window.innerWidth < 768 ? 25 : 30));

            // 创建连线
            const link = svg.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(links)
                .enter().append("line")
                .attr("class", "link")
                .attr("stroke-width", 2);

            // 创建节点组
            const node = svg.append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(nodes)
                .enter().append("g")
                .attr("class", "node-group")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            // 添加节点圆圈
            node.append("circle")
                .attr("class", "node")
                .attr("r", d => d.isCenter ? (window.innerWidth < 768 ? 22 : 25) : (window.innerWidth < 768 ? 18 : 20))
                .attr("fill", d => d.isCenter ? "#ff6b6b" : "#4ecdc4")
                .on("click", function(event, d) {
                    if (!d.isCenter && historicalData[d.id]) {
                        // 点击非中心节点，切换为新的中心节点
                        showGraph(d.id);
                    }
                })
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("r", d.isCenter ? (window.innerWidth < 768 ? 25 : 28) : (window.innerWidth < 768 ? 21 : 23));
                    showTooltip(event, d);
                })
                .on("mouseout", function(event, d) {
                    d3.select(this).attr("r", d.isCenter ? (window.innerWidth < 768 ? 22 : 25) : (window.innerWidth < 768 ? 18 : 20));
                    hideTooltip();
                });

            // 添加节点标签
            node.append("text")
                .attr("class", "node-label")
                .attr("dy", d => d.isCenter ? (window.innerWidth < 768 ? 35 : 40) : (window.innerWidth < 768 ? 30 : 35))
                .text(d => d.id)
                .style("font-size", d => d.isCenter ? (window.innerWidth < 768 ? "12px" : "14px") : (window.innerWidth < 768 ? "10px" : "12px"))
                .style("fill", "#333");

            // 添加关系标签（优化显示）
            const linkLabels = svg.append("g")
                .attr("class", "link-labels")
                .selectAll("text")
                .data(links)
                .enter().append("text")
                .attr("class", "link-label")
                .attr("text-anchor", "middle")
                .text(d => d.relation)
                .style("pointer-events", "none");

            // 更新模拟（统一tick事件）
            simulation.on("tick", () => {
                // 更新连线位置
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                // 更新节点位置
                node
                    .attr("transform", d => `translate(${d.x},${d.y})`);

                // 更新关系标签位置
                linkLabels
                    .attr("x", d => (d.source.x + d.target.x) / 2)
                    .attr("y", d => (d.source.y + d.target.y) / 2 - 5);
            });
        }

        // 拖拽功能（优化性能）
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // 工具提示（优化位置和样式）
        function showTooltip(event, d) {
            hideTooltip(); // 先清除旧的tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");

            // 适配移动端tooltip位置
            if (window.innerWidth < 768) {
                tooltip.style("max-width", "150px")
                       .style("font-size", "12px");
            }

            const content = `<strong>${d.id}</strong><br/>${d.description.substring(0, 40)}${d.description.length > 40 ? '...' : ''}`;
            tooltip.html(content);
        }

        function hideTooltip() {
            d3.selectAll(".tooltip").remove();
        }

        // 窗口大小变化时重新绘制图谱
        window.addEventListener('resize', () => {
            if (currentNode) {
                createGraph(currentNode);
            }
        });

        // 页面加载完成后聚焦输入框
        window.addEventListener('load', () => {
            document.getElementById('searchInput').focus();
        });
    </script>
</body>
</html>