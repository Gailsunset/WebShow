<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†å²äººç‰©å…³ç³»å›¾ - MVPç‰ˆæœ¬</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* æŸ¥è¯¢é¡µé¢æ ·å¼ */
        .query-page {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .query-section {
            margin-bottom: 25px;
        }

        .query-section h2 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2d3748;
        }

        .period-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .period-btn {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .period-btn:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .period-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .query-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.3s ease;
            width: 100%;
        }

        .query-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* å›¾è°±é¡µé¢æ ·å¼ */
        .graph-page {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .graph-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .back-btn, .filter-btn, .reset-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }

        .back-btn:hover, .filter-btn:hover, .reset-btn:hover {
            background: #3182ce;
        }

        .graph-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2d3748;
        }

        .graph-container {
            width: 100%;
            height: 600px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .node {
            cursor: pointer;
            stroke: #fff;
            stroke-width: 2px;
        }

        .node:hover {
            stroke-width: 3px;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }

        .relationship-label {
            font-size: 10px;
            fill: #666;
            text-anchor: middle;
            pointer-events: none;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 200px;
        }

        .filter-panel {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .filter-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-checkbox {
            margin: 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .stats {
            background: #edf2f7;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            color: #4a5568;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å†å²äººç‰©å…³ç³»å›¾</h1>
            <p>åŸºäºMVPè®¾è®¡ Â· å¿«é€ŸæŸ¥è¯¢ Â· ç›´è§‚æŸ¥çœ‹ Â· ç®€å•ç­›é€‰</p>
        </div>

        <!-- æŸ¥è¯¢é¡µé¢ -->
        <div class="query-page" id="queryPage">
            <div class="query-section">
                <h2>ğŸ” å¼€å§‹æ¢ç´¢å†å²äººç‰©å…³ç³»</h2>
                <p style="color: #666; margin-bottom: 20px;">è¾“å…¥å†å²æ—¶æœŸå’Œæ ¸å¿ƒäººç‰©ï¼Œå¿«é€Ÿè·å–å¯è§†åŒ–å…³ç³»å›¾è°±</p>
            </div>

            <div class="query-section">
                <label><strong>ğŸ›ï¸ é€‰æ‹©å†å²æ—¶æœŸï¼š</strong></label>
                <div class="form-group">
                    <div class="period-buttons">
                        <div class="period-btn active" data-period="å”æœ">å”æœ</div>
                        <div class="period-btn" data-period="å®‹æœ">å®‹æœ</div>
                        <div class="period-btn" data-period="æ˜æœ">æ˜æœ</div>
                        <div class="period-btn" data-period="æ¸…æœ">æ¸…æœ</div>
                        <div class="period-btn" data-period="ç§¦æ±‰">ç§¦æ±‰</div>
                        <div class="period-btn" data-period="ä¸‰å›½">ä¸‰å›½</div>
                    </div>
                </div>
            </div>

            <div class="query-section">
                <label for="characterInput"><strong>ğŸ‘¤ è¾“å…¥æ ¸å¿ƒäººç‰©ï¼š</strong></label>
                <div class="form-group">
                    <input type="text" id="characterInput" class="input-field" 
                           placeholder="ä¾‹å¦‚ï¼šæä¸–æ°‘ã€æç™½ã€åº·ç†™å¸..." />
                </div>
            </div>

            <div class="query-section">
                <button class="query-btn" onclick="searchRelationships()">
                    ğŸš€ æŸ¥è¯¢äººç‰©å…³ç³»å›¾
                </button>
            </div>
        </div>

        <!-- å›¾è°±é¡µé¢ -->
        <div class="graph-page" id="graphPage">
            <div class="graph-controls">
                <div>
                    <button class="back-btn" onclick="goBack()">â† è¿”å›æŸ¥è¯¢</button>
                    <span class="graph-title" id="graphTitle">å”æœ - æä¸–æ°‘ å…³ç³»å›¾è°±</span>
                </div>
                <div>
                    <button class="reset-btn" onclick="resetFilters()">é‡ç½®ç­›é€‰</button>
                </div>
            </div>

            <div class="filter-panel">
                <label><strong>ğŸ”— å…³ç³»ç­›é€‰ï¼š</strong></label>
                <div class="filter-options">
                    <div class="filter-option">
                        <input type="checkbox" class="filter-checkbox" id="familyFilter" checked onchange="applyFilters()">
                        <label for="familyFilter">äº²å±å…³ç³»</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" class="filter-checkbox" id="politicalFilter" checked onchange="applyFilters()">
                        <label for="politicalFilter">æ”¿æ²»å…³ç³»</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" class="filter-checkbox" id="otherFilter" checked onchange="applyFilters()">
                        <label for="otherFilter">å…¶ä»–å…³è”</label>
                    </div>
                </div>
            </div>

            <div class="stats" id="graphStats">
                å…±åŠ è½½ 0 ä¸ªèŠ‚ç‚¹ï¼Œ0 æ¡å…³ç³»çº¿
            </div>

            <div class="graph-container" id="graphContainer">
                <div class="loading" id="loadingText">
                    ç‚¹å‡»"æŸ¥è¯¢äººç‰©å…³ç³»å›¾"å¼€å§‹æ¢ç´¢
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip" style="display: none;"></div>

    <script>
        // æ¨¡æ‹Ÿå†å²äººç‰©æ•°æ®
        const historicalData = {
            "å”æœ": {
                "æä¸–æ°‘": {
                    "name": "æä¸–æ°‘",
                    "dynasty": "å”æœ",
                    "identity": "å”å¤ªå®—ï¼Œå”æœç¬¬äºŒä½çš‡å¸",
                    "relationships": [
                        {"name": "ææ¸Š", "type": "çˆ¶å­", "category": "äº²å±", "description": "çˆ¶äº²ï¼Œå”æœå¼€å›½çš‡å¸"},
                        {"name": "é•¿å­™çš‡å", "type": "å¤«å¦»", "category": "äº²å±", "description": "çš‡åï¼Œé•¿å­™æ— å¿Œä¹‹å¦¹"},
                        {"name": "é­å¾", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "è‘—åè°è‡£ï¼Œè´è§‚ä¹‹æ²»é‡è¦åŠŸè‡£"},
                        {"name": "æˆ¿ç„é¾„", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "å®°ç›¸ï¼Œè´è§‚åè‡£"},
                        {"name": "æœå¦‚æ™¦", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "å®°ç›¸ï¼Œè´è§‚åè‡£"},
                        {"name": "æé–", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "å¤§å°†ï¼Œå¹³å®šçªå¥"},
                        {"name": "æå»ºæˆ", "type": "å…„å¼Ÿ", "category": "äº²å±", "description": "å¤ªå­ï¼Œç„æ­¦é—¨ä¹‹å˜å¯¹ç«‹"},
                        {"name": "æå…ƒå‰", "type": "å…„å¼Ÿ", "category": "äº²å±", "description": "é½ç‹ï¼Œç„æ­¦é—¨ä¹‹å˜å¯¹ç«‹"}
                    ]
                },
                "æç™½": {
                    "name": "æç™½",
                    "dynasty": "å”æœ",
                    "identity": "è¯—ä»™ï¼Œå”ä»£è‘—åè¯—äºº",
                    "relationships": [
                        {"name": "å”ç„å®—", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "æ›¾ä¾›å¥‰ç¿°æ—ï¼Œä¸ºçš‡å¸ä½œè¯—"},
                        {"name": "è´ºçŸ¥ç« ", "type": "æœ‹å‹", "category": "å…¶ä»–", "description": "è¯—å‹ï¼Œç§°æç™½ä¸º'è°ªä»™äºº'"},
                        {"name": "æœç”«", "type": "æœ‹å‹", "category": "å…¶ä»–", "description": "å¤§è¯—äººï¼Œåä¸–å¹¶ç§°'ææœ'"},
                        {"name": "é«˜é€‚", "type": "æœ‹å‹", "category": "å…¶ä»–", "description": "è¾¹å¡è¯—äººï¼Œå¥½å‹"},
                        {"name": "å­Ÿæµ©ç„¶", "type": "æœ‹å‹", "category": "å…¶ä»–", "description": "å±±æ°´è¯—äººï¼Œå¥½å‹"}
                    ]
                }
            },
            "å®‹æœ": {
                "è‹è½¼": {
                    "name": "è‹è½¼",
                    "dynasty": "å®‹æœ",
                    "identity": "æ–‡å­¦å®¶ï¼Œå”å®‹å…«å¤§å®¶ä¹‹ä¸€",
                    "relationships": [
                        {"name": "å®‹ç¥å®—", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "åœ¨ä½æœŸé—´è‹è½¼ç»å†å¤šæ¬¡è´¬è°ª"},
                        {"name": "ç‹å®‰çŸ³", "type": "æ”¿æ•Œ", "category": "æ”¿æ²»", "description": "å˜æ³•æ´¾é¢†è¢–ï¼Œæ”¿æ²»è§‚ç‚¹å¯¹ç«‹"},
                        {"name": "å¸é©¬å…‰", "type": "æ”¿å‹", "category": "æ”¿æ²»", "description": "åå¯¹å˜æ³•ï¼Œåæ¥æˆä¸ºæœ‹å‹"},
                        {"name": "è‹è¾™", "type": "å…„å¼Ÿ", "category": "äº²å±", "description": "å¼Ÿå¼Ÿï¼ŒåŒæ ·ä¸ºè‘—åæ–‡å­¦å®¶"},
                        {"name": "é»„åº­åš", "type": "æœ‹å‹", "category": "å…¶ä»–", "description": "æ±Ÿè¥¿è¯—æ´¾ä»£è¡¨ï¼Œå¥½å‹"}
                    ]
                }
            },
            "æ˜æœ": {
                "æœ±å…ƒç’‹": {
                    "name": "æœ±å…ƒç’‹",
                    "dynasty": "æ˜æœ",
                    "identity": "æ˜å¤ªç¥–ï¼Œæ˜æœå¼€å›½çš‡å¸",
                    "relationships": [
                        {"name": "é©¬çš‡å", "type": "å¤«å¦»", "category": "äº²å±", "description": "çš‡åï¼Œæœ±å…ƒç’‹çš„é‡è¦æ”¯æŒè€…"},
                        {"name": "æœ±æ ‡", "type": "çˆ¶å­", "category": "äº²å±", "description": "å¤ªå­ï¼Œæœ±å…ƒç’‹å±æ„çš„ç»§æ‰¿äºº"},
                        {"name": "åˆ˜ä¼¯æ¸©", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "å†›å¸ˆï¼Œæ˜æœå¼€å›½åŠŸè‡£"},
                        {"name": "å¾è¾¾", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "å¤§å°†ï¼ŒåŒ—ä¼å…ƒæœçš„ä¸»å¸…"},
                        {"name": "èƒ¡æƒŸåº¸", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "ä¸ç›¸ï¼Œåå› è°‹åè¢«è¯›æ€"}
                    ]
                }
            },
            "æ¸…æœ": {
                "åº·ç†™å¸": {
                    "name": "åº·ç†™å¸",
                    "dynasty": "æ¸…æœ",
                    "identity": "æ¸…åœ£ç¥–ï¼Œæ¸…æœç¬¬å››ä½çš‡å¸",
                    "relationships": [
                        {"name": "å­åº„å¤ªå", "type": "ç¥–å­™", "category": "äº²å±", "description": "ç¥–æ¯ï¼Œé‡è¦çš„æ”¿æ²»æŒ‡å¯¼è€…"},
                        {"name": "é³Œæ‹œ", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "æƒè‡£ï¼Œåè¢«åº·ç†™æ™ºæ“’"},
                        {"name": "æ˜ç ", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "é‡è‡£ï¼Œç´¢é¢å›¾çš„æ”¿æ²»å¯¹æ‰‹"},
                        {"name": "ç´¢é¢å›¾", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "é‡è‡£ï¼Œåº·ç†™åˆæœŸé‡è¦å¤§è‡£"},
                        {"name": "èƒ¤ç¤½", "type": "çˆ¶å­", "category": "äº²å±", "description": "å¤ªå­ï¼Œä¸¤æ¬¡è¢«ç«‹åºŸ"}
                    ]
                }
            },
            "ç§¦æ±‰": {
                "åˆ˜é‚¦": {
                    "name": "åˆ˜é‚¦",
                    "dynasty": "ç§¦æ±‰",
                    "identity": "æ±‰é«˜ç¥–ï¼Œæ±‰æœå¼€å›½çš‡å¸",
                    "relationships": [
                        {"name": "å•é›‰", "type": "å¤«å¦»", "category": "äº²å±", "description": "çš‡åï¼Œåæ¥çš„å•å"},
                        {"name": "é¡¹ç¾½", "type": "æ•Œå¯¹", "category": "æ”¿æ²»", "description": "è¥¿æ¥šéœ¸ç‹ï¼Œä¸»è¦ç«äº‰å¯¹æ‰‹"},
                        {"name": "è§ä½•", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "ä¸ç›¸ï¼Œæ±‰åˆä¸‰æ°ä¹‹ä¸€"},
                        {"name": "å¼ è‰¯", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "è°‹å£«ï¼Œæ±‰åˆä¸‰æ°ä¹‹ä¸€"},
                        {"name": "éŸ©ä¿¡", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "å¤§å°†ï¼Œæ±‰åˆä¸‰æ°ä¹‹ä¸€"}
                    ]
                }
            },
            "ä¸‰å›½": {
                "åˆ˜å¤‡": {
                    "name": "åˆ˜å¤‡",
                    "dynasty": "ä¸‰å›½",
                    "identity": "èœ€æ±‰å¼€å›½çš‡å¸",
                    "relationships": [
                        {"name": "å…³ç¾½", "type": "å…„å¼Ÿ", "category": "äº²å±", "description": "ç»“ä¹‰å…„å¼Ÿï¼Œèœ€æ±‰å¤§å°†"},
                        {"name": "å¼ é£", "type": "å…„å¼Ÿ", "category": "äº²å±", "description": "ç»“ä¹‰å…„å¼Ÿï¼Œèœ€æ±‰å¤§å°†"},
                        {"name": "è¯¸è‘›äº®", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "ä¸ç›¸ï¼Œèœ€æ±‰é‡è¦è°‹å£«"},
                        {"name": "æ›¹æ“", "type": "æ•Œå¯¹", "category": "æ”¿æ²»", "description": "ä¸»è¦ç«äº‰å¯¹æ‰‹ï¼Œé­å›½å¥ åŸºäºº"},
                        {"name": "å­™æƒ", "type": "ç›Ÿå‹/æ•Œå¯¹", "category": "æ”¿æ²»", "description": "ä¸œå´å›ä¸»ï¼Œæ—¢æœ‰è”ç›Ÿä¹Ÿæœ‰å†²çª"}
                    ]
                }
            }
        };

        let currentPeriod = "å”æœ";
        let currentCharacter = "";
        let graphData = { nodes: [], links: [] };
        let svg, simulation;

        // æ—¶æœŸæŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentPeriod = this.dataset.period;
            });
        });

        // æŸ¥è¯¢äººç‰©å…³ç³»
        function searchRelationships() {
            const characterInput = document.getElementById('characterInput').value.trim();
            if (!characterInput) {
                alert('è¯·è¾“å…¥æ ¸å¿ƒäººç‰©å§“å');
                return;
            }

            currentCharacter = characterInput;
            showGraphPage();
            loadGraphData();
        }

        // æ˜¾ç¤ºå›¾è°±é¡µé¢
        function showGraphPage() {
            document.getElementById('queryPage').style.display = 'none';
            document.getElementById('graphPage').style.display = 'block';
            
            const title = `${currentPeriod} - ${currentCharacter} å…³ç³»å›¾è°±`;
            document.getElementById('graphTitle').textContent = title;
        }

        // è¿”å›æŸ¥è¯¢é¡µé¢
        function goBack() {
            document.getElementById('graphPage').style.display = 'none';
            document.getElementById('queryPage').style.display = 'block';
            document.getElementById('characterInput').value = '';
        }

        // åŠ è½½å›¾è°±æ•°æ®
        function loadGraphData() {
            const loadingText = document.getElementById('loadingText');
            loadingText.style.display = 'block';
            loadingText.textContent = 'æ­£åœ¨åŠ è½½å…³ç³»æ•°æ®...';

            // æ¨¡æ‹ŸåŠ è½½å»¶è¿Ÿ
            setTimeout(() => {
                const characterData = historicalData[currentPeriod]?.[currentCharacter];
                if (!characterData) {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç²¾ç¡®åŒ¹é…ï¼Œå°è¯•æ˜¾ç¤ºè¯¥æ—¶æœŸçš„å…¶ä»–äººç‰©
                    const periodData = historicalData[currentPeriod];
                    if (periodData && Object.keys(periodData).length > 0) {
                        const firstKey = Object.keys(periodData)[0];
                        currentCharacter = firstKey;
                        document.getElementById('graphTitle').textContent = `${currentPeriod} - ${firstKey} å…³ç³»å›¾è°±`;
                        characterData = periodData[firstKey];
                    } else {
                        loadingText.textContent = 'æš‚æ— è¯¥äººç‰©çš„å…³ç³»æ•°æ®ï¼Œæ˜¾ç¤ºç¤ºä¾‹æ•°æ®';
                        characterData = createSampleData();
                    }
                }

                graphData = createGraphFromCharacterData(characterData);
                renderGraph();
                loadingText.style.display = 'none';
                
                const stats = document.getElementById('graphStats');
                stats.textContent = `å…±åŠ è½½ ${graphData.nodes.length} ä¸ªèŠ‚ç‚¹ï¼Œ${graphData.links.length} æ¡å…³ç³»çº¿`;
            }, 1000);
        }

        // åˆ›å»ºç¤ºä¾‹æ•°æ®ï¼ˆå½“æ‰¾ä¸åˆ°æŒ‡å®šäººç‰©æ—¶ï¼‰
        function createSampleData() {
            return {
                name: "ç¤ºä¾‹äººç‰©",
                dynasty: currentPeriod,
                identity: "ç¤ºä¾‹å†å²äººç‰©",
                relationships: [
                    {"name": "å›ä¸»", "type": "å›è‡£", "category": "æ”¿æ²»", "description": "ä¸Šçº§é¢†å¯¼"},
                    {"name": "å®¶äºº", "type": "äº²å±", "category": "äº²å±", "description": "å®¶åº­æˆå‘˜"},
                    {"name": "æœ‹å‹", "type": "æœ‹å‹", "category": "å…¶ä»–", "description": "å¥½å‹å…³ç³»"},
                    {"name": "åŒåƒš", "type": "åŒäº‹", "category": "æ”¿æ²»", "description": "åŒäº‹å…³ç³»"}
                ]
            };
        }

        // ä»äººç‰©æ•°æ®åˆ›å»ºå›¾è°±æ•°æ®
        function createGraphFromCharacterData(characterData) {
            const nodes = [];
            const links = [];

            // æ·»åŠ ä¸­å¿ƒäººç‰©èŠ‚ç‚¹
            const mainNode = {
                id: characterData.name,
                name: characterData.name,
                dynasty: characterData.dynasty,
                identity: characterData.identity,
                type: 'main',
                category: 'center'
            };
            nodes.push(mainNode);

            // æ·»åŠ å…³ç³»èŠ‚ç‚¹å’Œè¿çº¿
            characterData.relationships.forEach(rel => {
                // å…³ç³»å¯¹è±¡èŠ‚ç‚¹
                const relatedNode = {
                    id: rel.name,
                    name: rel.name,
                    dynasty: 'ç›¸å…³äººç‰©',
                    identity: rel.description,
                    type: 'related',
                    category: rel.category
                };
                nodes.push(relatedNode);

                // å…³ç³»è¿çº¿
                const link = {
                    source: characterData.name,
                    target: rel.name,
                    relationship: rel.type,
                    category: rel.category,
                    description: rel.description
                };
                links.push(link);
            });

            return { nodes, links };
        }

        // æ¸²æŸ“å›¾è°±
        function renderGraph() {
            const container = document.getElementById('graphContainer');
            container.innerHTML = '';

            const width = container.clientWidth;
            const height = container.clientHeight;

            svg = d3.select('#graphContainer')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // åˆ›å»ºç¼©æ”¾è¡Œä¸º
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    svg.select('g').attr('transform', event.transform);
                });

            svg.call(zoom);

            const g = svg.append('g');

            // åˆ›å»ºåŠ›å¯¼å‘æ¨¡æ‹Ÿ
            simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2));

            // åˆ›å»ºè¿çº¿
            const link = g.append('g')
                .selectAll('line')
                .data(graphData.links.filter(link => isLinkVisible(link)))
                .enter().append('line')
                .attr('class', 'link');

            // åˆ›å»ºè¿çº¿æ ‡ç­¾
            const linkLabel = g.append('g')
                .selectAll('text')
                .data(graphData.links.filter(link => isLinkVisible(link)))
                .enter().append('text')
                .attr('class', 'relationship-label')
                .text(d => d.relationship);

            // åˆ›å»ºèŠ‚ç‚¹
            const node = g.append('g')
                .selectAll('circle')
                .data(graphData.nodes.filter(node => isNodeVisible(node)))
                .enter().append('circle')
                .attr('class', 'node')
                .attr('r', d => d.type === 'main' ? 20 : 12)
                .attr('fill', d => d.type === 'main' ? '#ff6b6b' : getNodeColor(d.category))
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // åˆ›å»ºèŠ‚ç‚¹æ ‡ç­¾
            const nodeLabels = g.append('g')
                .selectAll('text')
                .data(graphData.nodes.filter(node => isNodeVisible(node)))
                .enter().append('text')
                .attr('dx', d => d.type === 'main' ? 25 : 15)
                .attr('dy', 4)
                .text(d => d.name)
                .style('font-size', d => d.type === 'main' ? '12px' : '10px')
                .style('font-weight', d => d.type === 'main' ? 'bold' : 'normal')
                .style('fill', '#333');

            // å·¥å…·æç¤º
            const tooltip = d3.select('#tooltip');

            // èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
            node.on('click', function(event, d) {
                if (d.type === 'related') {
                    showPersonTooltip(event, d);
                }
            })
            .on('mouseover', function(event, d) {
                if (d.type === 'related') {
                    tooltip.style('display', 'block')
                        .html(`<strong>${d.name}</strong><br/>${d.identity}`)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                }
            })
            .on('mouseout', function() {
                tooltip.style('display', 'none');
            });

            // æ›´æ–°æ¨¡æ‹Ÿ
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                linkLabel
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                nodeLabels
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
        }

        // è·å–èŠ‚ç‚¹é¢œè‰²
        function getNodeColor(category) {
            const colors = {
                'äº²å±': '#4ecdc4',
                'æ”¿æ²»': '#45b7d1',
                'å…¶ä»–': '#96ceb4'
            };
            return colors[category] || '#feca57';
        }

        // åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å¯è§
        function isNodeVisible(node) {
            if (node.type === 'main') return true;
            
            const visibleCategories = getVisibleCategories();
            return visibleCategories.includes(node.category);
        }

        // åˆ¤æ–­è¿çº¿æ˜¯å¦å¯è§
        function isLinkVisible(link) {
            const visibleCategories = getVisibleCategories();
            return visibleCategories.includes(link.category);
        }

        // è·å–å¯è§çš„åˆ†ç±»
        function getVisibleCategories() {
            const categories = [];
            if (document.getElementById('familyFilter').checked) categories.push('äº²å±');
            if (document.getElementById('politicalFilter').checked) categories.push('æ”¿æ²»');
            if (document.getElementById('otherFilter').checked) categories.push('å…¶ä»–');
            return categories;
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            if (svg) {
                // é‡æ–°æ¸²æŸ“ä»¥åº”ç”¨ç­›é€‰
                const link = svg.select('g').selectAll('.link');
                const linkLabel = svg.select('g').selectAll('.relationship-label');
                const node = svg.select('g').selectAll('.node');
                const nodeLabels = svg.select('g').selectAll('text:nth-of-type(2)');

                // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œé‡æ–°æ¸²æŸ“æ•´ä¸ªå›¾è°±
                setTimeout(() => {
                    renderGraph();
                }, 100);
            }
        }

        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.getElementById('familyFilter').checked = true;
            document.getElementById('politicalFilter').checked = true;
            document.getElementById('otherFilter').checked = true;
            applyFilters();
        }

        // æ˜¾ç¤ºäººç‰©å·¥å…·æç¤º
        function showPersonTooltip(event, d) {
            const tooltip = d3.select('#tooltip');
            tooltip.style('display', 'block')
                .html(`<strong>${d.name}</strong><br/>${d.identity}`)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }

        // æ‹–æ‹½åŠŸèƒ½
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // å“åº”å¼è°ƒæ•´
        window.addEventListener('resize', function() {
            if (svg) {
                renderGraph();
            }
        });
    </script>
</body>
</html>