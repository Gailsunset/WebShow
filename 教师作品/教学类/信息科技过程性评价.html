<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ç­çº§è¿‡ç¨‹æ€§è¯„ä»·ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* é¡¶éƒ¨æ ‡é¢˜åŒº */
        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f1f8f4 100%);
            border-radius: 20px;
            padding: 35px 25px 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.15);
            border: 1px solid rgba(76, 175, 80, 0.1);
        }

        .title-edit {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            position: relative;
        }

        .title-edit::before {
            content: 'ğŸ“';
            font-size: 32px;
            position: absolute;
            left: 0;
            animation: float 3s ease-in-out infinite;
        }

        .title-edit::after {
            content: 'ğŸ“š';
            font-size: 32px;
            position: absolute;
            right: 0;
            animation: float 3s ease-in-out infinite;
            animation-delay: 1.5s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .title-input {
            font-size: 28px;
            font-weight: 700;
            color: transparent;
            background: linear-gradient(135deg, #2e7d32, #4caf50, #66bb6a);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            border: 2px dashed transparent;
            padding: 12px 20px;
            border-radius: 12px;
            transition: all 0.3s;
            background-color: transparent;
            text-align: center;
            flex: 1;
            max-width: 600px;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .title-input:hover {
            border-color: #4caf50;
            background-color: #f1f8f4;
            background: linear-gradient(135deg, #2e7d32, #4caf50, #66bb6a);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transform: scale(1.02);
        }

        .title-input:focus {
            outline: none;
            border-color: #4caf50;
            border-style: solid;
            background-color: white;
            background: linear-gradient(135deg, #1b5e20, #2e7d32, #4caf50);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }

        /* åŠŸèƒ½æŒ‰é’®åŒº */
        .nav-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-btn {
            flex: 1;
            min-width: 150px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #66bb6a, #4caf50);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
        }

        /* å·¥å…·æ  */
        .toolbar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar button,
        .toolbar input[type="file"] {
            padding: 10px 20px;
            border: 2px solid #4caf50;
            background: white;
            color: #4caf50;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .toolbar button:hover {
            background: #4caf50;
            color: white;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .file-label {
            padding: 10px 20px;
            border: 2px solid #4caf50;
            background: white;
            color: #4caf50;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-block;
        }

        .file-label:hover {
            background: #4caf50;
            color: white;
        }

        /* ä¸»å†…å®¹åŒº */
        .content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* åº§ä½è§†å›¾ */
        .seats-grid {
            display: grid;
            grid-template-columns: 60px repeat(6, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .seat-card {
            background: linear-gradient(135deg, #f1f8f4, #e8f5e9);
            border: 2px solid #c8e6c9;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .seat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.2);
        }

        .seat-card.selected {
            background: linear-gradient(135deg, #a5d6a7, #81c784);
            border-color: #4caf50;
            border-width: 3px;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }

        .seat-number {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .student-name {
            font-size: 16px;
            font-weight: 600;
            color: #2e7d32;
        }

        .attendance-status {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
        }

        .seat-card.present .attendance-status {
            background: #4caf50;
        }

        .seat-card.absent .attendance-status {
            background: #f44336;
        }

        .seat-card.leave .attendance-status {
            background: #ff9800;
        }

        /* ç§¯åˆ†æ¦œè§†å›¾ */
        .ranking-list {
            margin-top: 20px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px 20px;
            background: #f8fdf9;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .ranking-item:hover {
            background: #e8f5e9;
            transform: translateX(5px);
        }

        .rank-number {
            font-size: 24px;
            font-weight: 700;
            color: #4caf50;
            min-width: 40px;
        }

        .rank-number.top1 {
            color: #ffd700;
        }

        .rank-number.top2 {
            color: #c0c0c0;
        }

        .rank-number.top3 {
            color: #cd7f32;
        }

        .student-info {
            flex: 1;
        }

        .student-info .name {
            font-size: 16px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 5px;
        }

        .student-info .details {
            font-size: 12px;
            color: #666;
        }

        .score-display {
            font-size: 28px;
            font-weight: 700;
            color: #4caf50;
        }

        /* è¯„ä»·å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 20px;
            text-align: center;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border: none;
            background: #f5f5f5;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            color: #666;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #e0e0e0;
            transform: rotate(90deg);
        }

        .score-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .score-btn {
            padding: 15px;
            border: 2px solid #4caf50;
            background: white;
            color: #4caf50;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .score-btn:hover {
            background: #4caf50;
            color: white;
            transform: scale(1.05);
        }

        .score-btn.negative {
            border-color: #f44336;
            color: #f44336;
        }

        .score-btn.negative:hover {
            background: #f44336;
            color: white;
        }

        .eval-types {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .eval-type {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .eval-type.active {
            border-color: #4caf50;
            background: #4caf50;
            color: white;
        }

        .confirm-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #66bb6a, #4caf50);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        /* æ‰¹é‡æ“ä½œ */
        .batch-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .batch-btn {
            padding: 10px 20px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .batch-btn:hover {
            background: #1976d2;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 18px;
            color: #666;
        }

        /* å“åº”å¼ */
        @media (max-width: 1200px) {
            .seats-grid {
                grid-template-columns: 50px repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .seats-grid {
                grid-template-columns: 40px repeat(2, 1fr);
            }

            .group-label {
                font-size: 16px;
                padding: 10px 5px;
            }

            .nav-buttons {
                flex-direction: column;
            }

            .nav-btn {
                min-width: 100%;
            }

            .title-input {
                font-size: 20px;
                padding: 10px 15px;
                max-width: 90%;
            }

            .title-edit::before,
            .title-edit::after {
                font-size: 24px;
            }

            .header {
                padding: 25px 15px 20px;
            }
        }

        /* å°ç»„æ ‡ç­¾ */
        .group-label {
            background: linear-gradient(135deg, #66bb6a, #4caf50);
            color: white;
            padding: 15px 10px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ç­çº§ç­›é€‰ */
        .class-filter {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px 15px;
            background: #f0f8f5;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .class-filter label {
            font-size: 14px;
            color: #2e7d32;
            font-weight: 500;
        }

        .class-filter select {
            padding: 6px 12px;
            border: 2px solid #4caf50;
            border-radius: 6px;
            background: white;
            color: #2e7d32;
            font-size: 14px;
            cursor: pointer;
            min-width: 150px;
        }

        .class-filter select:focus {
            outline: none;
            border-color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨æ ‡é¢˜ -->
        <div class="header">
            <div class="title-edit">
                <input type="text" class="title-input" id="classTitle" value="ä»™ç”°å¤–å›½è¯­ä¸ƒ(5)ç­è¿‡ç¨‹æ€§è¯„ä»·ç³»ç»Ÿ">
            </div>
            <div class="nav-buttons">
                <button class="nav-btn active" data-view="attendance">ğŸ“‹ è€ƒå‹¤</button>
                <button class="nav-btn" data-view="callname">ğŸ¯ ç‚¹å</button>
                <button class="nav-btn" data-view="evaluate">â­ è¯„ä»·</button>
                <button class="nav-btn" data-view="ranking">ğŸ† ç§¯åˆ†æ¦œ</button>
            </div>
        </div>

        <!-- å·¥å…·æ  -->
        <div class="toolbar">
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".xlsx,.xls,.txt" onchange="handleFileUpload(event)">
                <label class="file-label" for="fileInput">ğŸ“‚ å¯¼å…¥å­¦ç”Ÿåå•</label>
            </div>
            <button onclick="exportData()">ğŸ“Š å¯¼å‡ºæ•°æ®</button>
            <button onclick="exportReport()">ğŸ“„ å¯¼å‡ºæŠ¥å‘Š</button>
            <button onclick="batchEvaluate()">âœ¨ æ‰¹é‡è¯„ä»·</button>
            <button onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
            <span style="margin-left: auto; color: #666; font-size: 14px;" id="studentCount">å­¦ç”Ÿäººæ•°: 0</span>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="content">
            <!-- è€ƒå‹¤è§†å›¾ -->
            <div id="attendanceView" class="view active">
                <h3 style="margin-bottom: 10px; color: #2e7d32;">ğŸ“‹ è€ƒå‹¤ç®¡ç†</h3>
                <div class="class-filter">
                    <label>ç­çº§ç­›é€‰ï¼š</label>
                    <select id="classFilterAttendance" onchange="filterByClass()">
                        <option value="all">å…¨éƒ¨ç­çº§</option>
                    </select>
                    <span id="attendanceStudentCount" style="color: #666; font-size: 14px; margin-left: 10px;"></span>
                </div>
                <div class="batch-actions">
                    <button class="batch-btn" onclick="markAllAttendance('present')">âœ“ å…¨éƒ¨å‡ºå‹¤</button>
                    <button class="batch-btn" onclick="markAllAttendance('absent')">âœ— å…¨éƒ¨ç¼ºå‹¤</button>
                    <button class="batch-btn" onclick="markAllAttendance('leave')">âŠ™ å…¨éƒ¨è¯·å‡</button>
                    <button class="batch-btn" onclick="markAllAttendance('')">â—‹ æ¸…é™¤æ ‡è®°</button>
                </div>
                <div class="seats-grid" id="seatsGrid"></div>
            </div>

            <!-- ç‚¹åè§†å›¾ -->
            <div id="callnameView" class="view">
                <h3 style="margin-bottom: 20px; color: #2e7d32;">ğŸ¯ éšæœºç‚¹å</h3>
                <div style="text-align: center; padding: 40px;">
                    <button class="confirm-btn" style="max-width: 300px; margin: 0 auto;" onclick="randomCall()">ğŸ² å¼€å§‹ç‚¹å</button>
                    <div id="calledName" style="font-size: 48px; font-weight: 700; color: #4caf50; margin-top: 40px; min-height: 60px;"></div>
                </div>
            </div>

            <!-- è¯„ä»·è§†å›¾ -->
            <div id="evaluateView" class="view">
                <h3 style="margin-bottom: 10px; color: #2e7d32;">â­ å­¦ç”Ÿè¯„ä»·</h3>
                <div class="class-filter">
                    <label>ç­çº§ç­›é€‰ï¼š</label>
                    <select id="classFilterEvaluate" onchange="filterByClass()">
                        <option value="all">å…¨éƒ¨ç­çº§</option>
                    </select>
                    <span id="evaluateStudentCount" style="color: #666; font-size: 14px; margin-left: 10px;"></span>
                </div>
                <div class="batch-actions">
                    <button class="batch-btn" onclick="toggleMultiSelect()">
                        <span id="multiSelectBtnText">âœ“ å¼€å¯å¤šé€‰</span>
                    </button>
                    <button class="batch-btn" onclick="batchEvaluateSelected()" id="batchEvalBtn" style="display: none;">
                        â­ æ‰¹é‡è¯„ä»·é€‰ä¸­çš„å­¦ç”Ÿ
                    </button>
                    <span id="selectedCount" style="color: #666; font-size: 14px; margin-left: 10px;"></span>
                </div>
                <div class="seats-grid" id="evaluateGrid"></div>
            </div>

            <!-- ç§¯åˆ†æ¦œè§†å›¾ -->
            <div id="rankingView" class="view">
                <h3 style="margin-bottom: 20px; color: #2e7d32;">ğŸ† ç§¯åˆ†æ’è¡Œæ¦œ</h3>
                <div class="ranking-list" id="rankingList"></div>
            </div>
        </div>
    </div>

    <!-- è¯„ä»·å¼¹çª— -->
    <div class="modal" id="evaluateModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeEvaluateModal()">Ã—</button>
            <div class="modal-header" id="modalTitle">è¯„ä»·å­¦ç”Ÿ</div>
            
            <div style="margin-bottom: 20px;">
                <div style="color: #666; font-size: 14px; margin-bottom: 10px;">é€‰æ‹©åˆ†æ•°ï¼š</div>
                <div class="score-buttons">
                    <button class="score-btn" onclick="selectScore(1)">+1</button>
                    <button class="score-btn" onclick="selectScore(2)">+2</button>
                    <button class="score-btn" onclick="selectScore(5)">+5</button>
                    <button class="score-btn negative" onclick="selectScore(-1)">-1</button>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <div style="color: #666; font-size: 14px; margin-bottom: 10px;">è¯„ä»·ç±»å‹ï¼š</div>
                <div class="eval-types">
                    <div class="eval-type" onclick="selectType(this, 'å‘è¨€')">å‘è¨€</div>
                    <div class="eval-type" onclick="selectType(this, 'ä½œä¸š')">ä½œä¸š</div>
                    <div class="eval-type" onclick="selectType(this, 'çºªå¾‹')">çºªå¾‹</div>
                    <div class="eval-type" onclick="selectType(this, 'äº’åŠ©')">äº’åŠ©</div>
                    <div class="eval-type" onclick="selectType(this, 'åˆ›æ–°')">åˆ›æ–°</div>
                    <div class="eval-type" onclick="selectType(this, 'å…¶ä»–')">å…¶ä»–</div>
                </div>
            </div>

            <button class="confirm-btn" onclick="confirmEvaluate()">ç¡®è®¤è¯„ä»·</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // å…¨å±€æ•°æ®
        let allStudents = []; // æ‰€æœ‰å­¦ç”Ÿæ•°æ®
        let students = []; // å½“å‰æ˜¾ç¤ºçš„å­¦ç”Ÿï¼ˆç­›é€‰åï¼‰
        let currentStudent = null;
        let selectedScore = 0;
        let selectedType = '';
        let currentClass = 'all'; // å½“å‰é€‰æ‹©çš„ç­çº§
        let multiSelectMode = false; // å¤šé€‰æ¨¡å¼
        let selectedStudents = []; // é€‰ä¸­çš„å­¦ç”ŸIDåˆ—è¡¨

        // åˆå§‹åŒ–
        window.onload = function() {
            loadFromLocalStorage();
            updateClassFilter();
            updateClassTitle();
            renderSeats();
            renderRanking();
            updateStudentCount();
            
            // åˆå§‹åŒ–å­¦ç”Ÿæ•°è®¡æ•°æ˜¾ç¤º
            if (students.length > 0) {
                document.getElementById('attendanceStudentCount').textContent = `å½“å‰æ˜¾ç¤º: ${students.length} äºº`;
                document.getElementById('evaluateStudentCount').textContent = `å½“å‰æ˜¾ç¤º: ${students.length} äºº`;
            }
        };

        // å¯¼èˆªåˆ‡æ¢
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                const viewId = this.dataset.view + 'View';
                document.getElementById(viewId).classList.add('active');
                
                if (this.dataset.view === 'evaluate') {
                    renderEvaluateGrid();
                } else if (this.dataset.view === 'ranking') {
                    renderRanking();
                }
            });
        });

        // æ–‡ä»¶å¯¼å…¥
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            if (file.name.endsWith('.txt')) {
                reader.onload = function(event) {
                    const content = event.target.result;
                    const lines = content.split('\n').map(line => line.trim()).filter(line => line);
                    
                    allStudents = lines.map((name, index) => ({
                        id: index + 1,
                        name: name,
                        score: 0,
                        attendance: '',
                        evaluations: [],
                        evaluationCount: 0,
                        class: '' // txtæ–‡ä»¶æ²¡æœ‰ç­çº§ä¿¡æ¯
                    }));
                    
                    students = [...allStudents];
                    currentClass = 'all';
                    
                    saveToLocalStorage();
                    updateClassFilter();
                    renderSeats();
                    renderRanking();
                    updateStudentCount();
                    alert(`æˆåŠŸå¯¼å…¥ ${allStudents.length} åå­¦ç”Ÿ`);
                };
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.onload = function(event) {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        allStudents = jsonData.map((row, index) => ({
                            id: index + 1,
                            name: row['æ–°ç”Ÿå§“å'] || row['å§“å'] || row['name'] || `å­¦ç”Ÿ${index + 1}`,
                            gender: row['æ€§åˆ«'] || '',
                            class: row['ç­çº§'] || '',
                            score: 0,
                            attendance: '',
                            evaluations: [],
                            evaluationCount: 0
                        }));
                        
                        students = [...allStudents];
                        currentClass = 'all';
                        
                        saveToLocalStorage();
                        updateClassFilter();
                        renderSeats();
                        renderRanking();
                        updateStudentCount();
                        alert(`æˆåŠŸå¯¼å…¥ ${allStudents.length} åå­¦ç”Ÿ`);
                    } catch (error) {
                        alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿æ ¼å¼æ­£ç¡®: ' + error.message);
                        console.error(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // æ›´æ–°ç­çº§ç­›é€‰ä¸‹æ‹‰æ¡†
        function updateClassFilter() {
            // è·å–æ‰€æœ‰ç­çº§
            const classes = [...new Set(allStudents.map(s => s.class).filter(c => c))];
            classes.sort();
            
            // æ›´æ–°ä¸¤ä¸ªä¸‹æ‹‰æ¡†
            const filters = ['classFilterAttendance', 'classFilterEvaluate'];
            filters.forEach(filterId => {
                const select = document.getElementById(filterId);
                select.innerHTML = '<option value="all">å…¨éƒ¨ç­çº§</option>';
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls;
                    option.textContent = cls;
                    select.appendChild(option);
                });
                select.value = currentClass;
            });
        }

        // ç­çº§ç­›é€‰
        function filterByClass() {
            // è·å–å½“å‰æ¿€æ´»çš„è§†å›¾å¯¹åº”çš„ç­›é€‰å™¨
            const activeView = document.querySelector('.view.active');
            let selectedClass = 'all';
            
            if (activeView.id === 'attendanceView') {
                selectedClass = document.getElementById('classFilterAttendance').value;
            } else if (activeView.id === 'evaluateView') {
                selectedClass = document.getElementById('classFilterEvaluate').value;
            }
            
            currentClass = selectedClass;
            
            // åŒæ­¥ä¸¤ä¸ªç­›é€‰å™¨çš„å€¼
            document.getElementById('classFilterAttendance').value = selectedClass;
            document.getElementById('classFilterEvaluate').value = selectedClass;
            
            // ç­›é€‰å­¦ç”Ÿ
            if (selectedClass === 'all') {
                students = [...allStudents];
            } else {
                students = allStudents.filter(s => s.class && s.class === selectedClass);
            }
            
            console.log('Filtering by class:', selectedClass);
            console.log('Filtered students:', students.length);
            
            // æ›´æ–°æ ‡é¢˜
            updateClassTitle();
            
            // æ¸…é™¤å¤šé€‰
            selectedStudents = [];
            multiSelectMode = false;
            updateMultiSelectUI();
            
            // é‡æ–°æ¸²æŸ“
            if (activeView.id === 'attendanceView') {
                renderSeats();
                document.getElementById('attendanceStudentCount').textContent = `å½“å‰æ˜¾ç¤º: ${students.length} äºº`;
            } else if (activeView.id === 'evaluateView') {
                renderEvaluateGrid();
                document.getElementById('evaluateStudentCount').textContent = `å½“å‰æ˜¾ç¤º: ${students.length} äºº`;
            }
            
            renderRanking();
            saveToLocalStorage();
        }

        // æ›´æ–°ç­çº§æ ‡é¢˜
        function updateClassTitle() {
            const titleInput = document.getElementById('classTitle');
            const baseTitle = 'ä»™ç”°å¤–å›½è¯­';
            
            if (currentClass === 'all' || !currentClass) {
                titleInput.value = baseTitle + 'è¿‡ç¨‹æ€§è¯„ä»·ç³»ç»Ÿ';
            } else {
                titleInput.value = baseTitle + currentClass + 'è¿‡ç¨‹æ€§è¯„ä»·ç³»ç»Ÿ';
            }
        }

        // æ¸²æŸ“åº§ä½
        function renderSeats() {
            const grid = document.getElementById('seatsGrid');
            if (students.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><div class="empty-state-text">è¯·å…ˆå¯¼å…¥å­¦ç”Ÿåå•</div></div>';
                return;
            }

            grid.innerHTML = '';
            const studentsPerGroup = 6;
            const totalGroups = 9; // å›ºå®š9ä¸ªå°ç»„
            const maxStudents = studentsPerGroup * totalGroups; // æœ€å¤š54äºº
            
            for (let groupIndex = 0; groupIndex < totalGroups; groupIndex++) {
                // æ·»åŠ å·¦ä¾§å°ç»„æ ‡ç­¾
                const groupLabel = document.createElement('div');
                groupLabel.className = 'group-label';
                groupLabel.textContent = groupIndex + 1;
                grid.appendChild(groupLabel);
                
                // è®¡ç®—è¯¥ç»„çš„å­¦ç”ŸèŒƒå›´ï¼ˆä¸¥æ ¼é™åˆ¶ä¸º6äººï¼‰
                const startIdx = groupIndex * studentsPerGroup;
                const endIdx = Math.min(startIdx + studentsPerGroup, students.length);
                
                // æ·»åŠ å­¦ç”Ÿå¡ç‰‡ï¼ˆæœ€å¤š6ä¸ªï¼‰
                let addedCount = 0;
                for (let i = startIdx; i < endIdx && addedCount < studentsPerGroup; i++) {
                    const student = students[i];
                const card = document.createElement('div');
                card.className = `seat-card ${student.attendance}`;
                card.innerHTML = `
                    <div class="attendance-status"></div>
                        <div class="seat-number">åº§ä½ ${i + 1}</div>
                        <div class="student-name">${student.name}</div>
                    `;
                    card.onclick = () => toggleAttendance(student.id);
                    grid.appendChild(card);
                    addedCount++;
                }
                
                // è¡¥å……ç©ºä½åˆ°6ä¸ª
                for (let i = addedCount; i < studentsPerGroup; i++) {
                    const emptyCard = document.createElement('div');
                    emptyCard.className = 'seat-card';
                    emptyCard.style.opacity = '0.3';
                    emptyCard.style.cursor = 'default';
                    emptyCard.innerHTML = `
                        <div class="seat-number">ç©ºä½</div>
                        <div class="student-name">-</div>
                    `;
                    grid.appendChild(emptyCard);
                }
            }
        }

        // æ¸²æŸ“è¯„ä»·ç½‘æ ¼
        function renderEvaluateGrid() {
            const grid = document.getElementById('evaluateGrid');
            if (students.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">â­</div><div class="empty-state-text">è¯·å…ˆå¯¼å…¥å­¦ç”Ÿåå•</div></div>';
                return;
            }

            grid.innerHTML = '';
            const studentsPerGroup = 6;
            const totalGroups = 9; // å›ºå®š9ä¸ªå°ç»„
            
            for (let groupIndex = 0; groupIndex < totalGroups; groupIndex++) {
                // æ·»åŠ å·¦ä¾§å°ç»„æ ‡ç­¾
                const groupLabel = document.createElement('div');
                groupLabel.className = 'group-label';
                groupLabel.textContent = groupIndex + 1;
                grid.appendChild(groupLabel);
                
                // è®¡ç®—è¯¥ç»„çš„å­¦ç”ŸèŒƒå›´ï¼ˆä¸¥æ ¼é™åˆ¶ä¸º6äººï¼‰
                const startIdx = groupIndex * studentsPerGroup;
                const endIdx = Math.min(startIdx + studentsPerGroup, students.length);
                
                // æ·»åŠ å­¦ç”Ÿå¡ç‰‡ï¼ˆæœ€å¤š6ä¸ªï¼‰
                let addedCount = 0;
                for (let i = startIdx; i < endIdx && addedCount < studentsPerGroup; i++) {
                    const student = students[i];
                    const card = document.createElement('div');
                    card.className = 'seat-card';
                    
                    // å¦‚æœåœ¨å¤šé€‰æ¨¡å¼ä¸‹ä¸”è¢«é€‰ä¸­ï¼Œæ·»åŠ selectedç±»
                    if (multiSelectMode && selectedStudents.includes(student.id)) {
                        card.classList.add('selected');
                    }
                    
                    card.innerHTML = `
                        <div class="seat-number">åº§ä½ ${i + 1}</div>
                        <div class="student-name">${student.name}</div>
                        <div style="font-size: 20px; color: #4caf50; margin-top: 8px;">${student.score}åˆ†</div>
                    `;
                    
                    // æ ¹æ®æ˜¯å¦å¤šé€‰æ¨¡å¼è®¾ç½®ç‚¹å‡»è¡Œä¸º
                    if (multiSelectMode) {
                        card.onclick = () => toggleStudentSelect(student.id);
                    } else {
                        card.onclick = () => openEvaluateModal(student);
                    }
                    
                    grid.appendChild(card);
                    addedCount++;
                }
                
                // è¡¥å……ç©ºä½åˆ°6ä¸ª
                for (let i = addedCount; i < studentsPerGroup; i++) {
                    const emptyCard = document.createElement('div');
                    emptyCard.className = 'seat-card';
                    emptyCard.style.opacity = '0.3';
                    emptyCard.style.cursor = 'default';
                    emptyCard.innerHTML = `
                        <div class="seat-number">ç©ºä½</div>
                        <div class="student-name">-</div>
                    `;
                    grid.appendChild(emptyCard);
                }
            }
        }

        // æ¸²æŸ“ç§¯åˆ†æ¦œ
        function renderRanking() {
            const list = document.getElementById('rankingList');
            if (students.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ†</div><div class="empty-state-text">è¯·å…ˆå¯¼å…¥å­¦ç”Ÿåå•</div></div>';
                return;
            }

            const sorted = [...students].sort((a, b) => b.score - a.score);
            
            list.innerHTML = '';
            sorted.forEach((student, index) => {
                const item = document.createElement('div');
                item.className = 'ranking-item';
                
                let rankClass = '';
                if (index === 0) rankClass = 'top1';
                else if (index === 1) rankClass = 'top2';
                else if (index === 2) rankClass = 'top3';
                
                const lastEval = student.evaluations && student.evaluations.length > 0 
                    ? student.evaluations[student.evaluations.length - 1] 
                    : null;
                
                item.innerHTML = `
                    <div class="rank-number ${rankClass}">${index + 1}</div>
                    <div class="student-info">
                        <div class="name">${student.name}</div>
                        <div class="details">
                            è¯„ä»·æ¬¡æ•°: ${student.evaluationCount || 0} æ¬¡
                            ${lastEval ? ` | æœ€è¿‘: ${lastEval.type} ${lastEval.score > 0 ? '+' : ''}${lastEval.score}åˆ†` : ''}
                        </div>
                    </div>
                    <div class="score-display">${student.score}</div>
                `;
                list.appendChild(item);
            });
        }

        // åˆ‡æ¢è€ƒå‹¤çŠ¶æ€
        function toggleAttendance(studentId) {
            // åœ¨ allStudents ä¸­æŸ¥æ‰¾å¹¶æ›´æ–°
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;

            const states = ['', 'present', 'absent', 'leave'];
            const currentIndex = states.indexOf(student.attendance);
            student.attendance = states[(currentIndex + 1) % states.length];
            
            // åŒæ­¥æ›´æ–° students æ•°ç»„ä¸­çš„ç›¸åŒå­¦ç”Ÿ
            const filteredStudent = students.find(s => s.id === studentId);
            if (filteredStudent) {
                filteredStudent.attendance = student.attendance;
            }
            
            saveToLocalStorage();
            renderSeats();
        }

        // æ‰¹é‡è€ƒå‹¤
        function markAllAttendance(status) {
            // æ›´æ–°å½“å‰æ˜¾ç¤ºçš„å­¦ç”Ÿ
            students.forEach(s => {
                s.attendance = status;
                // åŒæ­¥æ›´æ–° allStudents ä¸­çš„ç›¸åŒå­¦ç”Ÿ
                const studentInAll = allStudents.find(st => st.id === s.id);
                if (studentInAll) {
                    studentInAll.attendance = status;
                }
            });
            saveToLocalStorage();
            renderSeats();
        }

        // æ‰“å¼€è¯„ä»·å¼¹çª—
        function openEvaluateModal(student) {
            currentStudent = student;
            selectedScore = 0;
            selectedType = '';
            
            document.getElementById('modalTitle').textContent = `è¯„ä»· ${student.name}`;
            document.getElementById('evaluateModal').style.display = 'flex';
            
            // æ¸…é™¤é€‰ä¸­çŠ¶æ€
            updateScoreBtns();
            updateTypeBtns();
        }

        // å…³é—­å¼¹çª—
        function closeEvaluateModal() {
            document.getElementById('evaluateModal').style.display = 'none';
            currentStudent = null;
            selectedScore = 0;
            selectedType = '';
            selectedStudents = []; // æ¸…é™¤æ‰¹é‡é€‰æ‹©
        }

        // é€‰æ‹©åˆ†æ•°
        function selectScore(score) {
            selectedScore = score;
            updateScoreBtns();
        }

        // æ›´æ–°åˆ†æ•°æŒ‰é’®çŠ¶æ€
        function updateScoreBtns() {
            document.querySelectorAll('.score-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnScore = parseInt(btn.textContent);
                if (btnScore === selectedScore) {
                    btn.classList.add('active');
                }
            });
        }

        // é€‰æ‹©è¯„ä»·ç±»å‹
        function selectType(element, type) {
            selectedType = type;
            updateTypeBtns();
        }

        // æ›´æ–°è¯„ä»·ç±»å‹æŒ‰é’®çŠ¶æ€
        function updateTypeBtns() {
            document.querySelectorAll('.eval-type').forEach(el => {
                el.classList.remove('active');
                if (el.textContent.includes(selectedType.replace('å‘è¨€', '').replace('ä½œä¸š', '').replace('çºªå¾‹', '').replace('å…¶ä»–', ''))) {
                    el.classList.add('active');
                }
            });
        }

        // ç¡®è®¤è¯„ä»·åŠŸèƒ½å·²ç§»è‡³ä¸‹æ–¹ï¼Œæ”¯æŒæ‰¹é‡è¯„ä»·

        // éšæœºç‚¹å
        function randomCall() {
            if (students.length === 0) {
                alert('è¯·å…ˆå¯¼å…¥å­¦ç”Ÿåå•');
                return;
            }

            const presentStudents = students.filter(s => s.attendance === 'present' || s.attendance === '');
            if (presentStudents.length === 0) {
                alert('æ²¡æœ‰å¯ç‚¹åçš„å­¦ç”Ÿï¼ˆå»ºè®®æ ‡è®°å‡ºå‹¤çŠ¶æ€ï¼‰');
                return;
            }

            const randomIndex = Math.floor(Math.random() * presentStudents.length);
            const selected = presentStudents[randomIndex];
            
            document.getElementById('calledName').textContent = selected.name;
        }

        // æ‰¹é‡è¯„ä»·
        function batchEvaluate() {
            if (students.length === 0) {
                alert('è¯·å…ˆå¯¼å…¥å­¦ç”Ÿåå•');
                return;
            }

            const score = parseInt(prompt('è¯·è¾“å…¥è¦æ·»åŠ çš„åˆ†æ•°ï¼ˆå¯ä»¥æ˜¯è´Ÿæ•°ï¼‰:', '1'));
            if (isNaN(score) || score === 0) return;

            const type = prompt('è¯·è¾“å…¥è¯„ä»·ç±»å‹:', 'å‘è¨€');
            if (!type) return;

            const count = students.length;
            students.forEach(student => {
                student.score += score;
                student.evaluationCount = (student.evaluationCount || 0) + 1;
                if (!student.evaluations) student.evaluations = [];
                student.evaluations.push({
                    score: score,
                    type: type,
                    time: new Date().toLocaleString()
                });
                
                // åŒæ­¥æ›´æ–° allStudents ä¸­çš„ç›¸åŒå­¦ç”Ÿ
                const studentInAll = allStudents.find(s => s.id === student.id);
                if (studentInAll) {
                    studentInAll.score = student.score;
                    studentInAll.evaluationCount = student.evaluationCount;
                    studentInAll.evaluations = student.evaluations;
                }
            });

            saveToLocalStorage();
            renderEvaluateGrid();
            renderRanking();
            alert(`æ‰¹é‡è¯„ä»·æˆåŠŸï¼ä¸º ${count} åå­¦ç”Ÿå„${score > 0 ? '+' : ''}${score}åˆ†`);
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            // å¯¼å‡ºæ‰€æœ‰å­¦ç”Ÿæ•°æ®
            if (allStudents.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }

            const data = allStudents.map(s => ({
                'å§“å': s.name,
                'æ€§åˆ«': s.gender || '',
                'ç­çº§': s.class || '',
                'æ€»åˆ†': s.score,
                'è€ƒå‹¤çŠ¶æ€': s.attendance === 'present' ? 'å‡ºå‹¤' : s.attendance === 'absent' ? 'ç¼ºå‹¤' : s.attendance === 'leave' ? 'è¯·å‡' : 'æœªæ ‡è®°',
                'è¯„ä»·æ¬¡æ•°': s.evaluationCount || 0
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'å­¦ç”Ÿæ•°æ®');
            
            const className = document.getElementById('classTitle').value.replace(/è¿‡ç¨‹æ€§è¯„ä»·ç³»ç»Ÿ/g, '');
            XLSX.writeFile(wb, `${className}_è¯„ä»·æ•°æ®_${new Date().toLocaleDateString()}.xlsx`);
        }

        // å¯¼å‡ºæŠ¥å‘Š
        function exportReport() {
            // å¯¼å‡ºæ‰€æœ‰å­¦ç”Ÿçš„æŠ¥å‘Š
            if (allStudents.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }

            const sorted = [...allStudents].sort((a, b) => b.score - a.score);
            const avgScore = allStudents.reduce((sum, s) => sum + s.score, 0) / allStudents.length;
            const maxScore = sorted[0].score;
            const minScore = sorted[sorted.length - 1].score;

            const reportData = sorted.map((s, index) => {
                const participation = s.evaluationCount > avgScore ? 'é«˜' : s.evaluationCount < avgScore * 0.5 ? 'ä½' : 'ä¸­';
                const trend = s.score > avgScore ? 'ä¼˜ç§€' : s.score < avgScore * 0.5 ? 'éœ€å…³æ³¨' : 'è‰¯å¥½';
                
                return {
                    'æ’å': index + 1,
                    'å§“å': s.name,
                    'ç­çº§': s.class || '',
                    'æ€»åˆ†': s.score,
                    'è¯„ä»·æ¬¡æ•°': s.evaluationCount || 0,
                    'å‚ä¸åº¦': participation,
                    'ç»¼åˆè¡¨ç°': trend,
                    'æœ€è¿‘è¯„ä»·': s.evaluations && s.evaluations.length > 0 
                        ? `${s.evaluations[s.evaluations.length - 1].type} ${s.evaluations[s.evaluations.length - 1].score}åˆ†`
                        : 'æš‚æ— '
                };
            });

            const ws = XLSX.utils.json_to_sheet(reportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'å­¦ç”Ÿç”»åƒæŠ¥å‘Š');
            
            const className = document.getElementById('classTitle').value.replace(/è¿‡ç¨‹æ€§è¯„ä»·ç³»ç»Ÿ/g, '');
            XLSX.writeFile(wb, `${className}_å­¦ç”Ÿç”»åƒæŠ¥å‘Š_${new Date().toLocaleDateString()}.xlsx`);
        }

        // åˆ‡æ¢å¤šé€‰æ¨¡å¼
        function toggleMultiSelect() {
            multiSelectMode = !multiSelectMode;
            selectedStudents = [];
            updateMultiSelectUI();
            renderEvaluateGrid();
        }

        // æ›´æ–°å¤šé€‰UIçŠ¶æ€
        function updateMultiSelectUI() {
            const btnText = document.getElementById('multiSelectBtnText');
            const batchBtn = document.getElementById('batchEvalBtn');
            const selectedCount = document.getElementById('selectedCount');
            
            if (multiSelectMode) {
                btnText.textContent = 'âœ— å…³é—­å¤šé€‰';
                batchBtn.style.display = 'inline-block';
            } else {
                btnText.textContent = 'âœ“ å¼€å¯å¤šé€‰';
                batchBtn.style.display = 'none';
            }
            
            if (selectedStudents.length > 0) {
                selectedCount.textContent = `å·²é€‰æ‹©: ${selectedStudents.length} äºº`;
            } else {
                selectedCount.textContent = '';
            }
        }

        // åˆ‡æ¢å­¦ç”Ÿé€‰ä¸­çŠ¶æ€
        function toggleStudentSelect(studentId) {
            const index = selectedStudents.indexOf(studentId);
            if (index > -1) {
                selectedStudents.splice(index, 1);
            } else {
                selectedStudents.push(studentId);
            }
            updateMultiSelectUI();
            renderEvaluateGrid();
        }

        // æ‰¹é‡è¯„ä»·é€‰ä¸­çš„å­¦ç”Ÿ
        function batchEvaluateSelected() {
            if (selectedStudents.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦è¯„ä»·çš„å­¦ç”Ÿ');
                return;
            }
            
            // æ˜¾ç¤ºè¯„ä»·å¼¹çª—
            document.getElementById('evaluateModal').style.display = 'flex';
            document.getElementById('modalTitle').textContent = `æ‰¹é‡è¯„ä»· (å·²é€‰${selectedStudents.length}äºº)`;
            selectedScore = 0;
            selectedType = '';
            updateScoreBtns();
            updateTypeBtns();
        }

        // ä¿®æ”¹ç¡®è®¤è¯„ä»·å‡½æ•°ï¼Œæ”¯æŒæ‰¹é‡è¯„ä»·
        function confirmEvaluate() {
            if (selectedScore === 0 || !selectedType) {
                alert('è¯·é€‰æ‹©åˆ†æ•°å’Œè¯„ä»·ç±»å‹');
                return;
            }

            const timestamp = new Date().toLocaleString('zh-CN');

            // å¦‚æœæ˜¯æ‰¹é‡è¯„ä»·æ¨¡å¼
            if (selectedStudents.length > 0) {
                selectedStudents.forEach(studentId => {
                    const student = students.find(s => s.id === studentId);
                    if (student) {
                        student.score += selectedScore;
                        student.evaluationCount = (student.evaluationCount || 0) + 1;
                        
                        if (!student.evaluations) student.evaluations = [];
                        student.evaluations.push({
                            type: selectedType,
                            score: selectedScore,
                            time: timestamp
                        });
                        
                        // åŒæ­¥åˆ°allStudents
                        const studentInAll = allStudents.find(s => s.id === student.id);
                        if (studentInAll) {
                            studentInAll.score = student.score;
                            studentInAll.evaluationCount = student.evaluationCount;
                            studentInAll.evaluations = student.evaluations;
                        }
                    }
                });

                alert(`æ‰¹é‡è¯„ä»·æˆåŠŸï¼å·²ä¸º ${selectedStudents.length} åå­¦ç”Ÿè¯„ä»·`);
                selectedStudents = [];
                multiSelectMode = false;
                updateMultiSelectUI();
            } else if (currentStudent) {
                // å•ä¸ªå­¦ç”Ÿè¯„ä»·
                currentStudent.score += selectedScore;
                currentStudent.evaluationCount = (currentStudent.evaluationCount || 0) + 1;
                
                if (!currentStudent.evaluations) currentStudent.evaluations = [];
                currentStudent.evaluations.push({
                    type: selectedType,
                    score: selectedScore,
                    time: timestamp
                });
                
                // åŒæ­¥åˆ°allStudents
                const studentInAll = allStudents.find(s => s.id === currentStudent.id);
                if (studentInAll) {
                    studentInAll.score = currentStudent.score;
                    studentInAll.evaluationCount = currentStudent.evaluationCount;
                    studentInAll.evaluations = currentStudent.evaluations;
                }
            }

            closeEvaluateModal();
            renderEvaluateGrid();
            renderRanking();
            saveToLocalStorage();
        }

        // æ¸…ç©ºæ•°æ®
        function clearData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            
            allStudents = [];
            students = [];
            currentClass = 'all';
            selectedStudents = [];
            multiSelectMode = false;
            localStorage.removeItem('allStudents');
            localStorage.removeItem('currentClass');
            
            updateClassFilter();
            renderSeats();
            renderEvaluateGrid();
            renderRanking();
            updateStudentCount();
            
            alert('æ•°æ®å·²æ¸…ç©º');
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocalStorage() {
            localStorage.setItem('allStudents', JSON.stringify(allStudents));
            localStorage.setItem('currentClass', currentClass);
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('allStudents');
            if (saved) {
                try {
                    allStudents = JSON.parse(saved);
                    const savedClass = localStorage.getItem('currentClass') || 'all';
                    currentClass = savedClass;
                    
                    // åº”ç”¨ç­›é€‰
                    if (currentClass === 'all') {
                        students = [...allStudents];
                    } else {
                        students = allStudents.filter(s => s.class === currentClass);
                    }
                    
                    // æ›´æ–°ç­›é€‰å™¨
                    updateClassFilter();
                } catch (e) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥', e);
                    allStudents = [];
                    students = [];
                }
            }
        }

        // æ›´æ–°å­¦ç”Ÿæ•°é‡
        function updateStudentCount() {
            document.getElementById('studentCount').textContent = `å­¦ç”Ÿäººæ•°: ${allStudents.length}`;
        }

        // ä¿å­˜ç­çº§åç§°
        document.getElementById('classTitle').addEventListener('change', function() {
            localStorage.setItem('classTitle', this.value);
        });

        // åŠ è½½ç­çº§åç§°
        const savedTitle = localStorage.getItem('classTitle');
        if (savedTitle) {
            document.getElementById('classTitle').value = savedTitle;
        }
    </script>
</body>
</html>